# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Lint

on:
    push:
        branches: [ master ]
    pull_request:
        branches: [ master ]

jobs:
    build:
        runs-on: ubuntu-latest
        services:
            minio:
                image: minio/minio:edge-cicd
                ports:
                    - 9000:9000
                    - 9001:9001
        strategy:
            fail-fast: false
            matrix:
                python-version: [ '3.8', '3.9', '3.10.0-rc.1' ]
        steps:
            -   uses: actions/checkout@v2

            -   name: Cache poetry
                uses: actions/cache@v2
                with:
                    path: |
                        ~/.cache/pypoetry
                        ~/.cache/pip
                    key: ${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

            -   name: Cache minio client
                id: cache-mcli
                uses: actions/cache@v2
                with:
                    path: /home/runner/work/ekko/ekko/mc
                    key: ${{ runner.os }}

            -   name: Set up Python ${{ matrix.python-version }}
                uses: actions/setup-python@v2
                with:
                    python-version: ${{ matrix.python-version }}

            -   name: Install dependencies
                run: |
                    python -m pip install poetry
                    poetry config virtualenvs.create false
                    poetry install --no-interaction

            -   name: Get mcli
                if: steps.cache-mcli.outputs.cache-hit != 'true'
                run: |
                    wget https://dl.min.io/client/mc/release/linux-amd64/mc
                    chmod +x mc

            -   name: Create bucket
                run: |
                    ./mc config host add minio http://localhost:9000
                    ./mc mb minio/ekko

            -   name: Lint with flake8
                run: |
                    flake8 ekko tests

            -   name: Lint with mypy
                run: |
                    mypy ekko/

            -   name: Lint with black
                run: |
                    black --check ekko tests

            -   name: Test with pytest
                run: |
                    pytest --no-cov-on-fail --cov ekko --cov tests
